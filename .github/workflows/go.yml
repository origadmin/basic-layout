# This workflow demonstrates how to build and test a Go project.
# It is provided as an example for users of this template.
#
# This workflow is configured to be triggered manually via 'workflow_dispatch'
# to avoid unnecessary runs in the example repository.
# When using this in your own project, you would typically change the 'on:'
# trigger to 'push' and 'pull_request' for your main branch.

name: Go Example Build & Test

on:
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ^1.24 # Use Go 1.24 as specified in go.mod

      - name: Setup Environment
        run: |
          echo "GOPATH=$(go env GOPATH)" >> $GITHUB_ENV
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Go Module Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install Tools and Generate Code
        # This step uses the Makefile to install necessary tools (like buf, wire)
        # and then generates all protobuf-related code and wire DI code.
        run: make generate

      - name: Build Services
        # Uses the Makefile to build all defined services
        run: make build

      - name: Run Tests
        # Uses the Makefile to run all tests
        run: make test